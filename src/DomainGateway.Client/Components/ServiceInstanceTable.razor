@using DomainGateway.Client.Core.Models
@inject HttpClient Http

<div style="margin: 20px;">
	<h3>@this.ServiceName&nbsp;(@Instances.Count)</h3>
	<table class="table">
		<thead>
		<tr>
			<th>Instance ID</th>
			<th>Host</th>
			<th>Port</th>
			<th>Version</th>
			<th>Registered At</th>
			<th>Last Seen At</th>
			<th>Actions</th>
		</tr>
		</thead>
		<tbody>
		@foreach (var instance in this.Instances)
		{
			<tr>
				<td>@instance.InstanceId</td>
				<td>@instance.Host</td>
				<td>@instance.Port</td>
				<td>@instance.ServiceVersion</td>
				<td>@instance.RegistrationTime.ToString("yyyy-MM-dd HH:mm:ss zzz")</td>
				<td>@instance.LastSeenTime.ToString("yyyy-MM-dd HH:mm:ss zzz")</td>
				<td>
					<button class="btn btn-sm btn-outline-danger"
					        @onclick="() => this.DeregisterInstanceAsync(instance)"
					        disabled="@this._deregisteringInstances.Contains(instance.InstanceId)">
						@("Deregister")
					</button>
				</td>
			</tr>
		}
		</tbody>
	</table>
</div>

<style>
	table.table th,
	table.table td {
		vertical-align: middle;
	}
</style>

@code {

	[Parameter]
	public string ServiceName { get; set; } = string.Empty;

	[Parameter]
	public List<ServiceInstanceEntity> Instances { get; set; } = [];

	private readonly HashSet<string> _deregisteringInstances = new();

	private async Task DeregisterInstanceAsync(ServiceInstanceEntity instance)
	{
		if (this._deregisteringInstances.Contains(instance.InstanceId))
			return;

		this._deregisteringInstances.Add(instance.InstanceId);

		try
		{
			var response = await Http.DeleteAsync($"api/ServiceDiscovery/{instance.ServiceName}/{instance.InstanceId}");
			response.EnsureSuccessStatusCode();

			this.Instances.Remove(instance);
		}
		catch (Exception ex)
		{
			Console.Error.WriteLine($"Failed to deregister instance {instance.InstanceId}: {ex.Message}");
		}
		finally
		{
			this._deregisteringInstances.Remove(instance.InstanceId);
		}
	}
}
