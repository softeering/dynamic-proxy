@page "/service-registry"
@using DomainGateway.Client.Components
@using DomainGateway.Client.Core.Models

@inject HttpClient Http

<PageTitle>Service Registry</PageTitle>

<div class="d-flex align-items-center justify-content-between mb-3">
	<h1 class="mb-0">Services</h1>
	<button class="btn btn-outline-primary btn-sm" @onclick="this.LoadServicesAsync" disabled="@this._isLoading">
		<span class="bi bi-arrow-clockwise"></span>Refresh
	</button>
</div>

<div style="margin-top: 50px;">
	@if (this._isLoading && this._services is null && string.IsNullOrEmpty(this._message))
	{
		<p><em>Loading...</em></p>
	}
	else if (!string.IsNullOrEmpty(this._message))
	{
		<p>@this._message</p>
	}
	else if (this._services is not null)
	{
		@foreach (var (serviceName, instances) in this._services)
		{
			<ServiceInstanceTable ServiceName="@serviceName" Instances="@instances"/>
		}
	}
</div>

@code {
	private Dictionary<string, List<ServiceInstanceEntity>>? _services;
	private string? _message;
	private bool _isLoading;

	protected override async Task OnInitializedAsync()
	{
		await this.LoadServicesAsync();
	}

	private async Task LoadServicesAsync()
	{
		this._isLoading = true;
		this._message = null;

		try
		{
			var result = await Http.GetFromJsonAsync<List<ServiceInstanceEntity>>("api/servicediscovery/instances");

			if (result is null || result.Count == 0)
			{
				this._services = null;
				this._message = "No services are currently registered.";
			}
			else
			{
				this._services = result
					.GroupBy(s => s.ServiceName)
					.OrderBy(s => s.Key)
					.ToDictionary(s => s.Key, s => s.ToList());
			}
		}
		catch (Exception ex)
		{
			this._services = null;
			this._message = $"Failed to load services: {ex.Message}";
		}
		finally
		{
			this._isLoading = false;
		}
	}

}
